# Проект по тестированию VPN

## Цель проекта
Построить тестовый стенд и написать автотесты для проверки работы **VPN (WireGuard)** 
---

## Описание
В данном проекте реализовано следующее:
- Развернут **WireGuard** как сервер в Docker-контейнере.
- WireGuard настроен для работы в двух сетях:
  - `external_net` — внешняя сеть, откуда осуществляется подключение к VPN.
  - `internal_net` — защищённая внутренняя сеть.
- В сети `internal_net` запущен тестовый web-сервер **Nginx**, доступный только через VPN.
- В сети `external_net` запущен контейнер с тестовой средой, из которого выполняются автотесты.
- Тесты проверяют:
  - Доступность Nginx без VPN.
  - Установленное соединение с помощью `wg show`.
  - Доступность Nginx через VPN.
  - Корректность маршрутизации (`ip route`).
  - Состояние соединения на стороне сервера (через библиотеку [paramiko]).

---

## Используемые технологии
- **Docker Compose** — для разворачивания стенда.
- **WireGuard** — для организации VPN.
- **Nginx** — в роли тестового сервиса в защищённой сети.
- **Python / Pytest** — для написания автотестов.
- **Paramiko** — для удалённого выполнения команд на сервере.
- **Allure** — для генерации HTML-отчётов по результатам тестирования.

---

## Структура проекта
```
project/
├── docker-compose.yml              # Файл для разворачивания стенда
├── Dockerfile.client               # Определяет образ клиента для тестов
├── Dockerfile.wireguard            # Определяет образ сервера WireGuard
├── nginx/
│   ├── default.conf                # Конфигурация Nginx
│   └── index.html                  # Простая страница для тестирования доступности
├── wireguard/
│   ├── server/
│   │   └── peer1/
│   │       └── peer1.conf          # Конфигурация клиента (для подключения)
│   └── client/
│       └── wg0.conf                # Скопированный конфиг клиента (настройка после сборки)
├── tests/
│   ├── conftest.py                 # Общие фикстуры для тестов
│   └── test_vpn.py                 # Автотесты
├── .gitignore                      # Игнорируемые файлы - чтобы не коммитить результаты тестов и Allure-отчёты.
├── README.md                       # Этот файл
└── allure-results/                 # Результаты тестов
└── allure-report/                  # Allure-отчёты
```

---

##  Описание файлов

###  `Dockerfile.wireguard` — образ сервера WireGuard

**Назначение:**  
Создаёт Docker-образ, содержащий сервер WireGuard, настроенный на работу в защищённой сети. Также включает веб-сервер Nginx и SSH-доступ для управления.

**Ключевые параметры:**

- `TZ=Europe/Moscow` — временная зона.
- `SERVERURL=wireguard` — имя хоста сервера.
- `SERVERPORT=51820` — порт WireGuard (по умолчанию).
- `PEERS=1` — количество клиентов (один клиент).
- `INTERNAL_SUBNET=10.13.13.0/24` — подсеть, которую использует VPN.
- `ALLOWEDIPS=10.13.13.0/24,172.21.0.0/24` — разрешённые IP-адреса: внутренняя сеть + сеть `internal_net` (например, Nginx).


**Установка:**
- Устанавливает `openssh` и генерирует ключи.
- Настраивает SSH-доступ для `root` с паролем `123`.
- Настраивает `nginx` (в рамках `docker-compose.yml`) как веб-сервер, доступный только внутри `internal_net`.

>  Сервер **не должен быть доступен напрямую извне** — весь трафик должен проходить через WireGuard.

---

###  `Dockerfile.client` — образ клиента для автотестов

**Назначение:**  
Создаёт Docker-образ, который будет использоваться как тестовая среда. Он содержит всё необходимое для запуска автотестов с помощью `pytest`, а также инструменты для работы с WireGuard и SSH.

**Ключевые компоненты:**
- Базовый образ: `linuxserver/wireguard:latest`.
- Установлены:
  - `python3`, `pip`, `virtualenv` — для разработки и запуска тестов.
  - `openssh-client` — для подключения к серверу через SSH.
  - `curl`, `wireguard-tools` — для диагностики подключения.
- Создаёт виртуальное окружение `/venv`.
- Устанавливает зависимости: `pytest`, `allure-pytest`, `paramiko`, `requests`.

**Использование:**
- Контейнер запускается как **клиент**, который:
  - Подключается к WireGuard-серверу (через `wg quick up ...`).
  - Проверяет наличие интерфейса `wg0`.
  - Проверяет доступность Nginx по HTTP (`http://10.13.13.1:80`).
  - Выполняет тесты с помощью `pytest`.

>  **Безопасность:** Клиент не имеет прямого доступа к `internal_net` — только через установленный VPN-туннель.

---

###  `nginx/` — директория с конфигурацией веб-сервера

#### `nginx/index.html`
- Простая HTML-страница, которая отображается при обращении к `http://10.13.13.1`.
- Используется для проверки работоспособности Nginx **только через VPN**.

#### `nginx/default.conf`
- Конфигурационный файл Nginx, определяющий:
  - `listen 80;` — слушает на порту 80.
  - `server_name _;` — принимает все запросы.
  - `location / { root /usr/share/nginx/html; }` — указывает путь к `index.html`.
  - Логирование: `access_log /var/log/nginx/access.log;` и `error_log /var/log/nginx/error.log;`.
- Настроен так, чтобы **не отвечать вне VPN** (через `ALLOWEDIPS` в WireGuard).

>  **Примечание:** Nginx работает только в `internal_net`, и его можно достичь только через `wg0`.

---

##  Как работает стенд

1. **`docker-compose.yml`** создаёт контейнеры:
   - `wireguard-server`: сервер WireGuard + Nginx + SSH.
   - `client-test`: клиент для тестов (на базе `Dockerfile.client`).
   - `nginx` (если не входит в `wireguard-server`): веб-сервер, доступный только через `internal_net`.

2. При старте:
   - Сервер WireGuard настраивается с `INTERNAL_SUBNET=10.13.13.0/24`.
   - Клиент получает IP из этой подсети при подключении.
   - Веб-сервер (`Nginx`) слушает на `10.13.13.1:80` (внутри `internal_net`).

3. **Тесты**:
   - Сначала проверяют доступность `http://10.13.13.1` **без VPN** → должна быть ошибка (например, `Connection refused`).
   - Затем подключаются к VPN через `wg quick up ...`.
   - После подключения проверяют `http://10.13.13.1` → должно быть `200 OK`.

---

## Как использовать

### 1. Поднимаем стенд
```bash
docker-compose up -d
```

### 2. Копируем конфигурацию клиента WireGuard

> **Важно:** Конфигурация клиента генерируется автоматически на сервере. Его нужно скопировать в директорию `wireguard/client/`.

```bash
mkdir -p ./wireguard/client
cp ./wireguard/server/peer1/peer1.conf ./wireguard/client/wg0.conf
chmod 600 ./wireguard/client/wg0.conf
```

---

### 3. Генерируем HTML-отчёт
```bash
allure generate ./allure-results -o ./allure-report --clean
```

### 4. Открываем отчёт
```bash
allure serve ./allure-results
```

##  Выполненные критерии оценки
| Критерий | Выполнено |
|---------|-----------|
| Наличие `docker-compose.yml` | ✅ |
| Реализация указанных тестов | ✅ |
| Настройка отчётности (Allure) | ✅ |

---

## Тесты проверяют:
- Nginx недоступен без VPN.
- При подключении к VPN клиент видит интерфейс `wg0`.
- После подключения к VPN Nginx становится доступным.
- Маршрут через `wg0` добавлен в таблицу маршрутов.
- На стороне сервера отображается установленное соединение через `wg show`.

---
